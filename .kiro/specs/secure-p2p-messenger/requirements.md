# Документ Требований: Защищенный P2P Веб-Мессенджер

## Введение

Защищенный P2P веб-мессенджер - это веб-приложение для обмена сообщениями с end-to-end шифрованием, поддержкой голосовых и видео звонков, которое работает в любой стране благодаря использованию технологий обхода блокировок. Система использует peer-to-peer соединения для передачи медиа-данных и сигнальный сервер для координации соединений.

## Глоссарий

- **Система**: Веб-мессенджер с P2P шифрованием
- **Пользователь**: Человек, использующий мессенджер для общения
- **Сигнальный_Сервер**: Серверный компонент для координации P2P соединений
- **P2P_Соединение**: Прямое peer-to-peer соединение между клиентами
- **Веб_Клиент**: Браузерное приложение мессенджера
- **Сообщение**: Текстовое сообщение, фото, видео или голосовое сообщение
- **Медиа_Поток**: Аудио или видео поток в реальном времени
- **Сессия_Звонка**: Активное голосовое или видео соединение между пользователями
- **Шифрованный_Канал**: P2P соединение с end-to-end шифрованием

## Требования

### Требование 1: Регистрация и Аутентификация Пользователей

**User Story:** Как пользователь, я хочу зарегистрироваться и войти в систему, чтобы начать общаться с другими пользователями.

#### Критерии Приемки

1. WHEN пользователь предоставляет уникальный идентификатор и пароль, THE Система SHALL создать новую учетную запись
2. WHEN пользователь предоставляет существующий идентификатор и правильный пароль, THE Система SHALL аутентифицировать пользователя и создать сессию
3. WHEN пользователь предоставляет неправильный пароль, THE Система SHALL отклонить попытку входа и вернуть сообщение об ошибке
4. WHEN пользователь успешно аутентифицирован, THE Система SHALL сгенерировать пару криптографических ключей для P2P шифрования
5. THE Система SHALL хранить приватные ключи только на стороне клиента

### Требование 2: Обмен Текстовыми Сообщениями

**User Story:** Как пользователь, я хочу отправлять и получать текстовые сообщения, чтобы общаться с другими пользователями.

#### Критерии Приемки

1. WHEN пользователь отправляет текстовое сообщение, THE Система SHALL зашифровать сообщение перед отправкой
2. WHEN зашифрованное сообщение получено, THE Веб_Клиент SHALL расшифровать его и отобразить получателю
3. WHEN пользователь отправляет сообщение, THE Система SHALL отобразить сообщение в истории чата немедленно
4. WHEN сообщение доставлено получателю, THE Система SHALL отобразить индикатор доставки
5. THE Система SHALL сохранять историю сообщений в зашифрованном виде локально

### Требование 3: Обмен Медиа-Файлами

**User Story:** Как пользователь, я хочу отправлять и получать фото и видео, чтобы делиться визуальным контентом.

#### Критерии Приемки

1. WHEN пользователь выбирает фото или видео файл, THE Система SHALL зашифровать файл перед отправкой
2. WHEN зашифрованный медиа-файл получен, THE Веб_Клиент SHALL расшифровать его и отобразить получателю
3. WHEN пользователь отправляет медиа-файл, THE Система SHALL отобразить превью в истории чата
4. IF размер файла превышает 50 МБ, THEN THE Система SHALL отклонить загрузку и уведомить пользователя
5. THE Система SHALL поддерживать форматы изображений JPEG, PNG, GIF и форматы видео MP4, WebM

### Требование 4: Голосовые Сообщения

**User Story:** Как пользователь, я хочу записывать и отправлять голосовые сообщения, чтобы быстро передавать информацию голосом.

#### Критерии Приемки

1. WHEN пользователь начинает запись голосового сообщения, THE Веб_Клиент SHALL запросить доступ к микрофону
2. WHEN запись завершена, THE Система SHALL зашифровать аудио-файл перед отправкой
3. WHEN зашифрованное голосовое сообщение получено, THE Веб_Клиент SHALL расшифровать его и предоставить возможность воспроизведения
4. THE Система SHALL ограничить длительность голосового сообщения до 5 минут
5. THE Система SHALL отображать длительность голосового сообщения в истории чата

### Требование 5: Голосовые Звонки

**User Story:** Как пользователь, я хочу совершать голосовые звонки, чтобы общаться с другими пользователями в реальном времени.

#### Критерии Приемки

1. WHEN пользователь инициирует голосовой звонок, THE Система SHALL установить P2P_Соединение через Сигнальный_Сервер
2. WHEN P2P_Соединение установлено, THE Система SHALL передавать аудио через Шифрованный_Канал
3. WHEN получен входящий звонок, THE Веб_Клиент SHALL отобразить уведомление с возможностью принять или отклонить
4. WHEN пользователь завершает звонок, THE Система SHALL закрыть P2P_Соединение и освободить ресурсы
5. WHILE Сессия_Звонка активна, THE Система SHALL отображать длительность звонка
6. WHILE Сессия_Звонка активна, THE Система SHALL предоставлять возможность отключить микрофон

### Требование 6: Видео Звонки

**User Story:** Как пользователь, я хочу совершать видео звонки, чтобы видеть собеседника во время разговора.

#### Критерии Приемки

1. WHEN пользователь инициирует видео звонок, THE Система SHALL установить P2P_Соединение через Сигнальный_Сервер
2. WHEN P2P_Соединение установлено, THE Система SHALL передавать аудио и видео через Шифрованный_Канал
3. WHEN получен входящий видео звонок, THE Веб_Клиент SHALL отобразить уведомление с возможностью принять или отклонить
4. WHILE Сессия_Звонка активна, THE Система SHALL отображать видео собеседника и локальное видео
5. WHILE Сессия_Звонка активна, THE Система SHALL предоставлять возможность отключить камеру
6. WHILE Сессия_Звонка активна, THE Система SHALL предоставлять возможность отключить микрофон
7. WHEN пользователь завершает видео звонок, THE Система SHALL закрыть P2P_Соединение и освободить ресурсы

### Требование 7: P2P Шифрование

**User Story:** Как пользователь, я хочу, чтобы мои сообщения и звонки были защищены end-to-end шифрованием, чтобы никто кроме меня и получателя не мог их прочитать или прослушать.

#### Критерии Приемки

1. WHEN устанавливается соединение между пользователями, THE Система SHALL выполнить обмен ключами с использованием протокола Diffie-Hellman
2. THE Система SHALL шифровать все текстовые сообщения перед отправкой
3. THE Система SHALL шифровать все медиа-файлы перед отправкой
4. THE Система SHALL шифровать все Медиа_Потоки в реальном времени
5. THE Сигнальный_Сервер SHALL NOT иметь доступа к ключам шифрования или расшифрованному контенту
6. WHEN пользователь верифицирует контакт, THE Система SHALL отображать отпечаток ключа для сравнения

### Требование 8: Сигнальный Сервер

**User Story:** Как система, мне нужен сигнальный сервер для координации P2P соединений, чтобы пользователи могли находить друг друга и устанавливать прямые соединения.

#### Критерии Приемки

1. WHEN пользователь подключается к системе, THE Сигнальный_Сервер SHALL зарегистрировать пользователя как онлайн
2. WHEN пользователь инициирует звонок, THE Сигнальный_Сервер SHALL передать сигнальные сообщения получателю
3. WHEN P2P_Соединение установлено, THE Сигнальный_Сервер SHALL прекратить участие в передаче данных
4. THE Сигнальный_Сервер SHALL поддерживать протокол WebRTC для установки P2P соединений
5. THE Сигнальный_Сервер SHALL поддерживать WebSocket соединения для реального времени

### Требование 9: Обход Блокировок

**User Story:** Как пользователь, я хочу использовать мессенджер в любой стране, чтобы общаться независимо от локальных ограничений.

#### Критерии Приемки

1. THE Система SHALL поддерживать подключение через TURN серверы для обхода NAT и файрволов
2. WHERE прямое P2P соединение невозможно, THE Система SHALL использовать TURN сервер для ретрансляции трафика
3. THE Сигнальный_Сервер SHALL поддерживать подключение через WebSocket Secure (WSS)
4. THE Система SHALL поддерживать настройку пользовательских STUN/TURN серверов
5. THE Система SHALL автоматически выбирать оптимальный путь соединения

### Требование 10: Веб-Интерфейс

**User Story:** Как пользователь, я хочу использовать понятный и лаконичный веб-интерфейс, чтобы легко взаимодействовать с мессенджером.

#### Критерии Приемки

1. THE Веб_Клиент SHALL отображать список контактов с индикаторами онлайн статуса
2. THE Веб_Клиент SHALL отображать историю чата с временными метками
3. WHEN пользователь получает новое сообщение, THE Веб_Клиент SHALL отобразить уведомление
4. THE Веб_Клиент SHALL предоставлять интуитивные элементы управления для звонков
5. THE Веб_Клиент SHALL быть адаптивным и работать на различных размерах экрана
6. THE Веб_Клиент SHALL использовать минималистичный дизайн без избыточных элементов

### Требование 11: Управление Контактами

**User Story:** Как пользователь, я хочу управлять списком контактов, чтобы организовать свои связи.

#### Критерии Приемки

1. WHEN пользователь добавляет контакт по идентификатору, THE Система SHALL добавить контакт в список
2. WHEN пользователь удаляет контакт, THE Система SHALL удалить контакт из списка
3. THE Система SHALL отображать онлайн статус контактов в реальном времени
4. THE Система SHALL сохранять список контактов локально
5. WHEN контакт отправляет сообщение, THE Веб_Клиент SHALL отобразить непрочитанный счетчик

### Требование 12: Качество Медиа-Потоков

**User Story:** Как пользователь, я хочу, чтобы голосовые и видео звонки были понятными и качественными, чтобы комфортно общаться.

#### Критерии Приемки

1. THE Система SHALL использовать адаптивный битрейт для аудио в зависимости от качества соединения
2. THE Система SHALL использовать адаптивный битрейт для видео в зависимости от качества соединения
3. THE Система SHALL использовать кодеки Opus для аудио и VP8/VP9 для видео
4. WHEN качество соединения ухудшается, THE Система SHALL автоматически снизить качество видео
5. THE Система SHALL отображать индикатор качества соединения во время звонка
6. THE Система SHALL использовать эхоподавление и шумоподавление для аудио
