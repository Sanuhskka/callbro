# План Реализации: Защищенный P2P Веб-Мессенджер

## Обзор

Реализация будет выполнена поэтапно, начиная с базовой инфраструктуры и заканчивая продвинутыми функциями. Каждый этап включает реализацию функциональности и соответствующие тесты. Используется TypeScript для всех компонентов.

## Задачи

- [x] 1. Настройка проекта и базовой инфраструктуры
  - Создать монорепозиторий с workspace для клиента и сервера
  - Настроить TypeScript, ESLint, Prettier
  - Настроить Jest и fast-check для тестирования
  - Создать базовую структуру директорий
  - Настроить PostgreSQL базу данных
  - _Requirements: Все требования_

- [x] 2. Реализация модуля криптографии
  - [x] 2.1 Создать CryptoService с методами генерации ключей и шифрования
    - Реализовать generateKeyPair() используя Web Crypto API с ECDH P-256
    - Реализовать deriveSharedSecret() для обмена ключами
    - Реализовать encryptMessage() и decryptMessage() с AES-GCM-256
    - Реализовать encryptFile() и decryptFile() для медиа-файлов
    - _Requirements: 7.1, 7.2, 7.3_

  - [x] 2.2 Написать property-тест для round-trip шифрования текстовых сообщений
    - **Property 1: Round-trip шифрования текстовых сообщений**
    - **Validates: Requirements 2.1, 2.2, 7.2**

  - [x] 2.3 Написать property-тест для round-trip шифрования медиа-файлов
    - **Property 2: Round-trip шифрования медиа-файлов**
    - **Validates: Requirements 3.1, 3.2, 7.3**

  - [x] 2.4 Написать property-тест для round-trip шифрования голосовых сообщений
    - **Property 3: Round-trip шифрования голосовых сообщений**
    - **Validates: Requirements 4.2, 4.3**

  - [x] 2.5 Написать property-тест для обмена ключами
    - **Property 23: Обмен ключами при установке соединения**
    - **Validates: Requirements 7.1**


- [x] 3. Реализация сигнального сервера
  - [x] 3.1 Создать WebSocket сервер с поддержкой WSS
    - Настроить ws библиотеку для Node.js
    - Реализовать WebSocketServer с методами start(), stop()
    - Добавить ping/pong для проверки живых соединений
    - Настроить TLS сертификаты для WSS
    - _Requirements: 8.5, 9.3_

  - [x] 3.2 Реализовать модуль аутентификации сервера
    - Создать AuthMiddleware с verifyToken() и generateToken()
    - Использовать jsonwebtoken для JWT токенов
    - Настроить проверку токена при WebSocket подключении
    - _Requirements: 1.2_

  - [x] 3.3 Реализовать UserManager для управления пользователями
    - Создать PostgreSQL таблицы users и contacts
    - Реализовать createUser(), getUserById(), getUserByUsername()
    - Использовать bcrypt для хеширования паролей
    - _Requirements: 1.1, 1.2_

  - [x] 3.4 Реализовать SignalRouter для маршрутизации сообщений
    - Создать маппинг userId -> WebSocket клиент
    - Реализовать routeMessage() для передачи сигналов
    - Добавить проверку онлайн статуса получателя
    - _Requirements: 8.1, 8.2, 8.4_

  - [x] 3.5 Написать unit-тесты для сигнального сервера
    - Тест подключения клиента
    - Тест маршрутизации сообщений
    - Тест обработки разрыва соединения
    - _Requirements: 8.1, 8.2, 8.5_

  - [x] 3.6 Написать property-тест для регистрации онлайн статуса
    - **Property 26: Регистрация онлайн статуса**
    - **Validates: Requirements 8.1**

  - [x] 3.7 Написать property-тест для доставки сигнальных сообщений
    - **Property 27: Доставка сигнальных сообщений**
    - **Validates: Requirements 8.2**

- [x] 4. Checkpoint - Проверка базовой инфраструктуры
  - ✅ Все клиентские тесты проходят (27 тестов)
  - ✅ Модуль криптографии реализован с property-тестами
  - ✅ Сигнальный сервер реализован (WebSocket, AuthMiddleware, UserManager, SignalRouter)
  - ✅ Unit и property тесты для серверной части созданы
  - ✅ Базовая инфраструктура готова к продолжению разработки

- [x] 5. Реализация модуля аутентификации клиента
  - [x] 5.1 Создать AuthService для клиента
    - Реализовать register() с генерацией ключевой пары
    - Реализовать login() с созданием сессии
    - Реализовать logout() и getCurrentUser()
    - Хранить JWT токены в localStorage
    - _Requirements: 1.1, 1.2, 1.4_

  - [x] 5.2 Написать property-тест для создания учетной записи
    - **Property 4: Создание учетной записи с уникальным идентификатором**
    - **Validates: Requirements 1.1**

  - [x] 5.3 Написать property-тест для успешной аутентификации
    - **Property 5: Успешная аутентификация с правильными данными**
    - **Validates: Requirements 1.2**

  - [x] 5.4 Написать property-тест для отклонения неправильного пароля
    - **Property 6: Отклонение неправильного пароля**
    - **Validates: Requirements 1.3**

  - [x] 5.5 Написать property-тест для генерации ключей при аутентификации
    - **Property 7: Генерация ключей при аутентификации**
    - **Validates: Requirements 1.4**

  - [x] 5.6 Написать property-тест для приватных ключей только на клиенте
    - **Property 8: Приватные ключи только на клиенте**
    - **Validates: Requirements 1.5**

- [x] 6. Реализация модуля обмена сообщениями
  - [x] 6.1 Создать MessagingService
    - Реализовать sendTextMessage() с шифрованием
    - Реализовать sendMediaFile() и sendVoiceMessage()
    - Реализовать getMessageHistory() с расшифровкой
    - Настроить IndexedDB для хранения сообщений
    - _Requirements: 2.1, 2.2, 2.5, 3.1, 4.2_

  - [x] 6.2 Написать property-тест для немедленного отображения сообщения
    - **Property 9: Немедленное отображение отправленного сообщения**
    - **Validates: Requirements 2.3**

  - [x] 6.3 Написать property-тест для индикатора доставки
    - **Property 10: Индикатор доставки сообщения**
    - **Validates: Requirements 2.4**

  - [x] 6.4 Написать property-тест для локального хранения зашифрованных сообщений
    - **Property 11: Локальное хранение зашифрованных сообщений**
    - **Validates: Requirements 2.5**

  - [x] 6.5 Написать unit-тесты для граничных случаев
    - Тест отправки пустого сообщения
    - Тест отправки очень длинного сообщения
    - Тест отправки файла размером 50MB (граница)
    - _Requirements: 2.1, 3.4_

- [x] 7. Реализация модуля управления контактами
  - [x] 7.1 Создать ContactService
    - Реализовать addContact() и removeContact()
    - Реализовать getContacts() с загрузкой из IndexedDB
    - Реализовать getContactStatus() и onStatusChange()
    - _Requirements: 11.1, 11.2, 11.3, 11.4_

  - [x] 7.2 Написать property-тест для добавления контакта
    - **Property 39: Добавление контакта**
    - **Validates: Requirements 11.1**

  - [x] 7.3 Написать property-тест для удаления контакта
    - **Property 40: Удаление контакта**
    - **Validates: Requirements 11.2**

  - [x] 7.4 Написать property-тест для обновления статуса контактов
    - **Property 41: Обновление онлайн статуса контактов**
    - **Validates: Requirements 11.3**

  - [x] 7.5 Написать property-тест для локального хранения контактов
    - **Property 42: Локальное хранение контактов**
    - **Validates: Requirements 11.4**

  - [x] 7.6 Написать property-тест для счетчика непрочитанных
    - **Property 43: Счетчик непрочитанных сообщений**
    - **Validates: Requirements 11.5**

- [x] 8. Checkpoint - Проверка базовой функциональности сообщений
  - ✅ Все клиентские тесты проходят (44 теста)
  - ✅ MessagingService реализован с поддержкой текстовых, медиа и голосовых сообщений
  - ✅ ContactService реализован с управлением контактами и статусами
  - ✅ IndexedDB настроена для локального хранения сообщений и контактов
  - ✅ Базовая функциональность сообщений готова к продолжению разработки


- [x] 9. Реализация модуля сигнализации клиента
  - [x] 9.1 Создать SignalingService
    - Реализовать connect() и disconnect() к WebSocket серверу
    - Реализовать sendOffer(), sendAnswer(), sendIceCandidate()
    - Добавить обработчики onIncomingCall(), onOffer(), onAnswer(), onIceCandidate()
    - Реализовать автоматическое переподключение с экспоненциальной задержкой
    - Добавить heartbeat для поддержания соединения
    - _Requirements: 8.2, 8.4, 8.5_

  - [x] 9.2 Написать unit-тесты для сигнализации
    - Тест подключения к серверу
    - Тест отправки и получения сигналов
    - Тест автоматического переподключения
    - _Requirements: 8.5_

- [x] 10. Реализация модуля WebRTC
  - [x] 10.1 Создать WebRTCService для управления звонками
    - Реализовать initiateCall() для голосовых и видео звонков
    - Реализовать answerCall() и rejectCall()
    - Реализовать endCall() с освобождением ресурсов
    - Настроить RTCPeerConnection с ICE серверами
    - Реализовать обмен SDP offer/answer через SignalingService
    - _Requirements: 5.1, 5.4, 6.1, 6.7_

  - [x] 10.2 Добавить шифрование медиа-потоков
    - Использовать Insertable Streams API для шифрования фреймов
    - Интегрировать с CryptoService для получения ключей
    - _Requirements: 5.2, 6.2, 7.4_

  - [x] 10.3 Реализовать управление медиа-устройствами
    - Реализовать toggleMute() для отключения микрофона
    - Реализовать toggleVideo() для отключения камеры
    - Добавить обработку ошибок доступа к устройствам
    - _Requirements: 5.6, 6.5, 6.6_

  - [x] 10.4 Настроить адаптивный битрейт
    - Реализовать мониторинг качества соединения через RTCStatsReport
    - Реализовать автоматическую адаптацию битрейта через setParameters()
    - Настроить кодеки Opus для аудио и VP8/VP9 для видео
    - _Requirements: 12.1, 12.2, 12.3, 12.4_

  - [x] 10.5 Написать property-тест для установки P2P соединения
    - **Property 16: Установка P2P соединения для звонков**
    - **Validates: Requirements 5.1, 6.1**

  - [x] 10.6 Написать property-тест для шифрования медиа-потоков
    - **Property 17: Шифрование медиа-потоков**
    - **Validates: Requirements 5.2, 6.2, 7.4**

  - [x] 10.7 Написать property-тест для закрытия соединения
    - **Property 18: Закрытие соединения при завершении звонка**
    - **Validates: Requirements 5.4, 6.7**

  - [x] 10.8 Написать property-тест для функции отключения микрофона
    - **Property 20: Функция отключения микрофона**
    - **Validates: Requirements 5.6, 6.6**

  - [x] 10.9 Написать property-тест для функции отключения камеры
    - **Property 22: Функция отключения камеры**
    - **Validates: Requirements 6.5**

  - [x] 10.10 Написать unit-тесты для обработки ошибок WebRTC
    - Тест отказа в доступе к медиа-устройствам
    - Тест потери соединения во время звонка
    - Тест таймаута при установке соединения
    - _Requirements: 5.1, 6.1_

- [ ] 11. Настройка TURN/STUN серверов
  - [ ] 11.1 Настроить coturn сервер
    - Установить и настроить coturn
    - Настроить STUN и TURN функциональность
    - Настроить аутентификацию через временные credentials
    - _Requirements: 9.1, 9.2_

  - [ ] 11.2 Интегрировать TURN/STUN в WebRTCService
    - Добавить конфигурацию ICE серверов в RTCPeerConnection
    - Реализовать fallback на TURN при невозможности P2P
    - Добавить поддержку пользовательских STUN/TURN серверов
    - _Requirements: 9.1, 9.2, 9.4_

  - [ ] 11.3 Написать property-тест для поддержки TURN
    - **Property 31: Поддержка TURN для обхода блокировок**
    - **Validates: Requirements 9.1**

  - [ ] 11.4 Написать property-тест для fallback на TURN
    - **Property 32: Fallback на TURN при невозможности P2P**
    - **Validates: Requirements 9.2**

  - [ ] 11.5 Написать property-тест для настройки пользовательских серверов
    - **Property 34: Настройка пользовательских STUN/TURN серверов**
    - **Validates: Requirements 9.4**

- [ ] 12. Checkpoint - Проверка функциональности звонков
  - Убедиться, что все тесты проходят, спросить пользователя если возникли вопросы.

- [x] 13. Реализация веб-интерфейса
  - [x] 13.1 Создать базовую структуру React приложения
    - Настроить React с TypeScript
    - Создать основные компоненты: App, Login, Register, ChatList, Chat, Call
    - Настроить React Router для навигации
    - _Requirements: 10.1, 10.2_

  - [x] 13.2 Реализовать компоненты аутентификации
    - Создать LoginForm и RegisterForm компоненты
    - Интегрировать с AuthService
    - Добавить валидацию форм
    - _Requirements: 1.1, 1.2_

  - [x] 13.3 Реализовать список контактов
    - Создать ContactList компонент
    - Отображать онлайн статусы контактов
    - Добавить возможность добавления/удаления контактов
    - Отображать счетчик непрочитанных сообщений
    - _Requirements: 10.1, 11.1, 11.2, 11.5_

  - [x] 13.4 Реализовать компонент чата
    - Создать ChatWindow компонент
    - Отображать историю сообщений с временными метками
    - Реализовать отправку текстовых сообщений
    - Добавить поддержку отправки медиа-файлов
    - Отображать превью медиа-файлов
    - _Requirements: 2.3, 3.3, 10.2_

  - [x] 13.5 Реализовать компонент голосовых сообщений
    - Создать VoiceRecorder компонент
    - Запрашивать доступ к микрофону
    - Реализовать запись и отправку голосовых сообщений
    - Ограничить длительность до 5 минут
    - Отображать длительность в истории
    - _Requirements: 4.1, 4.4, 4.5_

  - [x] 13.6 Реализовать компонент звонков
    - Создать CallWindow компонент
    - Отображать видео собеседника и локальное видео
    - Добавить кнопки управления (mute, video off, end call)
    - Отображать длительность звонка
    - Отображать индикатор качества соединения
    - _Requirements: 5.5, 6.4, 12.5_

  - [x] 13.7 Реализовать уведомления
    - Создать NotificationService
    - Отображать уведомления о новых сообщениях
    - Отображать уведомления о входящих звонках
    - _Requirements: 10.3_

  - [x] 13.8 Добавить адаптивный дизайн
    - Использовать CSS Grid/Flexbox для адаптивности
    - Создать медиа-запросы для мобильных устройств
    - Тестировать на различных размерах экрана
    - _Requirements: 10.5_

  - [x] 13.9 Написать unit-тесты для React компонентов
    - Тест рендеринга компонентов
    - Тест взаимодействия пользователя
    - Тест интеграции с сервисами
    - _Requirements: 10.1, 10.2, 10.3_


- [ ] 14. Реализация дополнительных property-тестов
  - [ ] 14.1 Написать property-тест для отображения превью медиа
    - **Property 12: Отображение превью медиа-файлов**
    - **Validates: Requirements 3.3**

  - [ ] 14.2 Написать property-тест для поддержки форматов медиа
    - **Property 13: Поддержка форматов медиа-файлов**
    - **Validates: Requirements 3.5**

  - [ ] 14.3 Написать property-тест для ограничения длительности голосовых сообщений
    - **Property 14: Ограничение длительности голосовых сообщений**
    - **Validates: Requirements 4.4**

  - [ ] 14.4 Написать property-тест для отображения длительности голосовых сообщений
    - **Property 15: Отображение длительности голосового сообщения**
    - **Validates: Requirements 4.5**

  - [ ] 14.5 Написать property-тест для отображения длительности звонка
    - **Property 19: Отображение длительности звонка**
    - **Validates: Requirements 5.5**

  - [ ] 14.6 Написать property-тест для отображения видео-потоков
    - **Property 21: Отображение видео-потоков**
    - **Validates: Requirements 6.4**

  - [ ] 14.7 Написать property-тест для отсутствия доступа сервера к ключам
    - **Property 24: Сервер не имеет доступа к ключам**
    - **Validates: Requirements 7.5**

  - [ ] 14.8 Написать property-тест для отображения отпечатка ключа
    - **Property 25: Отображение отпечатка ключа**
    - **Validates: Requirements 7.6**

  - [ ] 14.9 Написать property-тест для отсутствия участия сервера в передаче данных
    - **Property 28: Сервер не участвует в передаче данных после установки P2P**
    - **Validates: Requirements 8.3**

  - [ ] 14.10 Написать property-тест для поддержки WebRTC сигнализации
    - **Property 29: Поддержка WebRTC сигнализации**
    - **Validates: Requirements 8.4**

  - [ ] 14.11 Написать property-тест для поддержки WebSocket
    - **Property 30: Поддержка WebSocket соединений**
    - **Validates: Requirements 8.5**

  - [ ] 14.12 Написать property-тест для поддержки WSS
    - **Property 33: Поддержка WSS соединений**
    - **Validates: Requirements 9.3**

  - [ ] 14.13 Написать property-тест для отображения списка контактов
    - **Property 35: Отображение списка контактов со статусами**
    - **Validates: Requirements 10.1**

  - [ ] 14.14 Написать property-тест для отображения истории чата
    - **Property 36: Отображение истории чата с метками времени**
    - **Validates: Requirements 10.2**

  - [ ] 14.15 Написать property-тест для уведомлений о новых сообщениях
    - **Property 37: Уведомления о новых сообщениях**
    - **Validates: Requirements 10.3**

  - [ ] 14.16 Написать property-тест для адаптивности интерфейса
    - **Property 38: Адаптивность интерфейса**
    - **Validates: Requirements 10.5**

  - [ ] 14.17 Написать property-тест для адаптивного битрейта аудио
    - **Property 44: Адаптивный битрейт аудио**
    - **Validates: Requirements 12.1**

  - [ ] 14.18 Написать property-тест для адаптивного битрейта видео
    - **Property 45: Адаптивный битрейт видео**
    - **Validates: Requirements 12.2**

  - [ ] 14.19 Написать property-тест для использования правильных кодеков
    - **Property 46: Использование правильных кодеков**
    - **Validates: Requirements 12.3**

  - [ ] 14.20 Написать property-тест для автоматического снижения качества видео
    - **Property 47: Автоматическое снижение качества видео**
    - **Validates: Requirements 12.4**

  - [ ] 14.21 Написать property-тест для индикатора качества соединения
    - **Property 48: Индикатор качества соединения**
    - **Validates: Requirements 12.5**

  - [ ] 14.22 Написать property-тест для эхоподавления и шумоподавления
    - **Property 49: Эхоподавление и шумоподавление**
    - **Validates: Requirements 12.6**

- [x] 15. Интеграционное тестирование
  - [x] 15.1 Написать интеграционные тесты для полного flow
    - Тест регистрации → вход → отправка сообщения
    - Тест установки голосового звонка между двумя клиентами
    - Тест обмена медиа-файлами
    - Тест переподключения после разрыва WebSocket
    - _Requirements: Все требования_

- [x] 16. Настройка развертывания
  - [x] 16.1 Создать Docker конфигурацию
    - Dockerfile для клиента (Nginx)
    - Dockerfile для сервера (Node.js)
    - Dockerfile для PostgreSQL
    - Dockerfile для coturn
    - docker-compose.yml для локального развертывания

  - [x] 16.2 Настроить переменные окружения
    - Создать .env.example файлы
    - Документировать все необходимые переменные
    - Настроить различные окружения (dev, staging, prod)

  - [x] 16.3 Создать документацию по развертыванию
    - Инструкции по локальному запуску
    - Инструкции по развертыванию на сервере
    - Инструкции по настройке TURN/STUN серверов
    - Инструкции по настройке SSL сертификатов

- [ ] 17. Финальный checkpoint - Полное тестирование системы
  - Убедиться, что все тесты проходят, спросить пользователя если возникли вопросы.

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и граничные случаи
- Все property-тесты должны выполняться минимум 100 итераций
- Используется TypeScript для всех компонентов (клиент и сервер)
